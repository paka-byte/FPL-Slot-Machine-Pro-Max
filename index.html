<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FPL Slot Machine ‚Äî Pro (DataFPL)</title>
<style>
  :root{ --bg1:#123524;--bg2:#0a7e6e;--accent:#00ff88;--danger:#ff4444; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Trebuchet MS',sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;margin:0;display:flex;flex-direction:column;align-items:center;}
  h1{margin:18px 12px 4px;font-size:clamp(1.6rem,3.5vw,2.6rem);text-shadow:2px 2px #000}
  .sub{opacity:.85;margin-bottom:8px;font-size:.95rem}
  .wrap{width:min(960px,100%);padding:0 12px 16px}
  .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .control-card{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:10px}
  .control-card h3{margin:0 0 8px;font-size:1rem;opacity:.9}
  .input-container{display:grid;grid-template-columns:repeat(3,minmax(120px,1fr));gap:8px}
  .input-container input{padding:10px;font-size:16px;border-radius:10px;border:none;text-align:center;outline:none}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,.stat{padding:10px;border-radius:10px;border:none;font-size:15px;background:#ffffff;color:#111;font-weight:600;min-width:160px}
  .stat{background:#0d2e25;color:#eafcf3;border:1px solid rgba(255,255,255,.12)}
  .reels{display:flex;justify-content:center;margin:22px 0 10px;gap:16px;width:100%}
  .reel{width:clamp(96px,18vw,140px);height:clamp(96px,18vw,140px);background:#fff;color:#000;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:clamp(18px,3.2vw,26px);font-weight:800;box-shadow:2px 2px 2px #0003;}
  .btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:8px 0 0}
  button{padding:12px 18px;font-size:17px;border:none;border-radius:10px;cursor:pointer;font-weight:800}
  #spinBtn{background:var(--accent);color:#000}
  #resetBtn{background:var(--danger);color:#fff;display:none}
  #muteBtn{background:#222;color:#fff}
  #saveBtn{background:#0b0b0b;color:#fff;border:1px solid rgba(255,255,255,.18)}
  #result{margin:10px 12px 8px;font-size:clamp(20px,3.6vw,30px);font-weight:900;min-height:40px;text-shadow:2px 2px #000;word-break:break-word;text-align:center}
  #history{font-size:.95rem;opacity:.95;display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
  .chip{background:#083228;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12)}
  canvas#confetti{position:fixed;inset:0;pointer-events:none;z-index:9998}
  footer{margin-top:auto;opacity:.75;padding:8px 0 14px;font-size:.85rem}

  /* NEW: top-right logo + dancing gif overlay */
  .page-logo{position:fixed;top:10px;right:10px;max-width:96px;max-height:96px;border-radius:12px;box-shadow:0 4px 12px #0006;z-index:9999;display:none;background:#0000}
  .gif-overlay{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999;display:none;pointer-events:none;max-width:min(40vw,360px);filter:drop-shadow(0 10px 16px rgba(0,0,0,.45))}
  .hint{opacity:.7;font-size:.9rem;margin-top:6px}
  .mini{font-size:.85rem;opacity:.85}
  .pill{border-radius:999px;padding:6px 10px;background:#0e2c24;border:1px solid rgba(255,255,255,.1)}
  .row-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .row-controls button{padding:8px 12px;font-size:14px}
  .input-sm{padding:8px;border-radius:10px;border:none;font-size:14px;min-width:220px}
</style>

<!-- Preload audio for smooth experience -->
<link rel="preload" href="sounds/spin.mp3" as="audio">
<link rel="preload" href="sounds/tick.mp3" as="audio">
<link rel="preload" href="sounds/jackpot.mp3" as="audio">
<link rel="preload" href="sounds/fail.mp3" as="audio">
</head>
<body>
  <img id="pageLogo" class="page-logo" alt="Page Logo">
  <img id="danceGif" class="gif-overlay" alt="Dance">

  <h1>üé∞ FPL Slot Machine ‚Äî Pro (Random)</h1>
  <div class="sub">Weighted jackpot: starts <b>20%</b>, +<b>10%</b> each miss, resets to 20% on hit (Just for fun).</div>

  <div class="wrap">
    <div class="controls">
      <div class="control-card">
        <h3>Players</h3>
        <div class="input-container" id="inputs">
          <!-- KEEP original 6 inputs (we still use & can extend to 8) -->
          <input value="Salah">
          <input value="Haaland">
          <input value="Ekitike">
          <input value="Saka">
          <input value="Bruno">
          <input value="Palmer">
        </div>
        <div class="row-controls">
          <button id="addPlayerBtn" class="pill">‚ûï Add Player</button>
          <button id="removePlayerBtn" class="pill">‚ûñ Remove Player</button>
          <span class="mini">Min 3 ‚Ä¢ Max 8 ‚Ä¢ <b id="playerCount">6</b> players</span>
        </div>
        <div class="hint">Tip: press Enter to save names. Your setup persists automatically.</div>
      </div>

      <div class="control-card">
        <h3>Theme & Stats</h3>
        <div class="row">
          <select id="themeSelect" title="Theme">
            <option value="Default FPL">Default (Green)</option>
            <option value="Arsenal">Arsenal</option>
            <option value="Liverpool">Liverpool</option>
            <option value="ManCity">Man City</option>
            <option value="Spurs">Spurs</option>
            <option value="Chelsea">Chelsea</option>
            <option value="ManUnited">Man United</option>
          </select>
          <div class="stat" id="statSpins">Spins: 0</div>
          <div class="stat" id="statJackpots">Jackpots: 0</div>
          <div class="stat" id="statRate">Rate: 0%</div>
          <div class="stat" id="statChance">Chance: 20%</div>
        </div>

        <!-- NEW: Logo & GIF inputs -->
        <div class="row" style="margin-top:10px">
          <input id="logoUrl" class="input-sm" placeholder="Logo URL (e.g., images/logo.png)">
          <input id="gifUrl" class="input-sm" placeholder="GIF URL (e.g., images/dance.gif)">
          <label class="pill" style="cursor:pointer">
            üìÅ Upload Logo
            <input id="logoFile" type="file" accept="image/*" style="display:none">
          </label>
          <button id="clearLogoBtn" class="pill">‚ùå Clear Logo</button>
        </div>
      </div>
    </div>

    <div class="reels">
      <div class="reel" id="reel1">?</div>
      <div class="reel" id="reel2">?</div>
      <div class="reel" id="reel3">?</div>
    </div>

    <div class="btns">
      <button id="spinBtn">SPIN!</button>
      <button id="resetBtn">Play Again</button>
      <button id="muteBtn" aria-pressed="false">üîä Sound On</button>
      <button id="saveBtn" title="Save current result as an image">üíæ Save Result</button>
    </div>

    <div id="result" role="status" aria-live="polite"></div>
    <div id="history"></div>
  </div>

  <canvas id="confetti"></canvas>

<script>
(() => {
  const LS_KEY = "fplslot_pro_random_v2"; // bumped key
  const themes = {
    Default:{bg1:"#123524", bg2:"#0a7e6e", accent:"#00ff88"},
    Arsenal:{bg1:"#8a0303", bg2:"#ff4d4d", accent:"#ffd700"},
    Liverpool:{bg1:"#006341", bg2:"#d00027", accent:"#ffd700"},
    ManCity:{bg1:"#6ca6d9", bg2:"#1b4f72", accent:"#f5f5f5"},
    Spurs:{bg1:"#0c2340", bg2:"#1f4b99", accent:"#f0eaea"},
    Chelsea:{bg1:"#001489", bg2:"#0d3685", accent:"#ffd700"},
    ManUnited:{bg1:"#da291c", bg2:"#111111", accent:"#ffd100"},
    "Default FPL":{bg1:"#123524", bg2:"#0a7e6e", accent:"#00ff88"} // alias
  };

  let state = {
    spinCount: 0, jackpots: 0,
    names: ["Salah","Haaland","Ekitike","Saka","Bruno","Palmer"], // dynamic len 3..8
    theme: "Default",
    history: [],
    jackpotChance: 0.2, // start 20%
    logoDataUrl: "",    // persisted logo (data URL or http URL)
    gifUrl: ""          // dancing gif url
  };

  const reels = [document.getElementById("reel1"), document.getElementById("reel2"), document.getElementById("reel3")];
  const inputsWrap = document.getElementById("inputs");
  const themeSelect = document.getElementById("themeSelect");
  const statSpins = document.getElementById("statSpins");
  const statJackpots = document.getElementById("statJackpots");
  const statRate = document.getElementById("statRate");
  const statChance = document.getElementById("statChance");
  const resultDiv = document.getElementById("result");
  const historyDiv = document.getElementById("history");
  const spinBtn = document.getElementById("spinBtn");
  const resetBtn = document.getElementById("resetBtn");
  const muteBtn = document.getElementById("muteBtn");
  const saveBtn = document.getElementById("saveBtn");
  const addPlayerBtn = document.getElementById("addPlayerBtn");
  const removePlayerBtn = document.getElementById("removePlayerBtn");
  const playerCountSpan = document.getElementById("playerCount");
  const logoEl = document.getElementById("pageLogo");
  const danceGifEl = document.getElementById("danceGif");
  const logoUrlInput = document.getElementById("logoUrl");
  const gifUrlInput = document.getElementById("gifUrl");
  const logoFileInput = document.getElementById("logoFile");
  const clearLogoBtn = document.getElementById("clearLogoBtn");

  // --- AUDIO SETUP ---
  const spinMusic = new Audio('sounds/spin.mp3');
  const tickSound = new Audio('sounds/tick.mp3');
  const jackpotSound = new Audio('sounds/jackpot.mp3');
  const failSound = new Audio('sounds/fail.mp3');
  spinMusic.volume = 0.6;
  tickSound.volume = 0.2;
  jackpotSound.volume = 0.8;
  failSound.volume = 0.5;

  let spinning = false, muted = false, audioPrimed = false;
  function primeAudio(){
    if (audioPrimed) return;
    [spinMusic, tickSound, jackpotSound, failSound].forEach(a=>{
      a.play().then(()=>{ a.pause(); a.currentTime = 0; }).catch(()=>{});
    });
    audioPrimed = true;
  }
  document.body.addEventListener("pointerdown", primeAudio, { once:true });

  function setMuted(on){
    muted = on;
    [spinMusic, tickSound, jackpotSound, failSound].forEach(a => a.muted = on);
    muteBtn.textContent = muted ? "üîá Sound Off" : "üîä Sound On";
    muteBtn.setAttribute("aria-pressed", muted ? "true" : "false");
  }
  muteBtn.addEventListener("click", () => setMuted(!muted));

  function applyTheme(name){
    const th = themes[name] || themes["Default"];
    document.documentElement.style.setProperty("--bg1", th.bg1);
    document.documentElement.style.setProperty("--bg2", th.bg2);
    document.documentElement.style.setProperty("--accent", th.accent);
    state.theme = name; saveState();
  }
  themeSelect.addEventListener("change", e => applyTheme(e.target.value));

  function loadState(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw){ Object.assign(state, JSON.parse(raw)); } }catch(e){} }
  function saveState(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){} }

  function getPlayerInputs(){ return [...inputsWrap.querySelectorAll("input")]; }
  function updatePlayerCountUI(){
    const cnt = getFaces().length;
    playerCountSpan.textContent = cnt;
    addPlayerBtn.disabled = cnt >= 8;
    removePlayerBtn.disabled = cnt <= 3;
  }

  function populateInputs(){
    // fill existing 6 inputs first
    const baseInputs = getPlayerInputs();
    let i = 0;
    for (; i < Math.min(state.names.length, baseInputs.length); i++){
      baseInputs[i].value = state.names[i] || "";
    }
    // append more if needed
    for (; i < state.names.length; i++){
      appendPlayerInput(state.names[i]);
    }
    // Ensure min 3 inputs
    while (getPlayerInputs().length < 3){
      appendPlayerInput("");
    }
    wirePlayerInputs();
    updatePlayerCountUI();
  }

  function appendPlayerInput(val=""){
    const inp = document.createElement("input");
    inp.value = val;
    inputsWrap.appendChild(inp);
  }

  function wirePlayerInputs(){
    getPlayerInputs().forEach(inp=>{
      inp.addEventListener("change", saveNames);
      inp.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); saveNames(); inp.blur(); }});
    });
  }

  function getFaces(){
    const arr = getPlayerInputs().map(i=>(i.value||"").trim()).filter(Boolean);
    return arr.length ? arr : ["?","?","?"];
  }

  function saveNames(){
    state.names = getPlayerInputs().map(i=>(i.value||"").trim());
    saveState();
    updatePlayerCountUI();
  }

  addPlayerBtn.addEventListener("click", ()=>{
    const cnt = getPlayerInputs().length;
    if (cnt >= 8) return;
    appendPlayerInput("");
    wirePlayerInputs();
    saveNames();
  });
  removePlayerBtn.addEventListener("click", ()=>{
    const inputs = getPlayerInputs();
    if (inputs.length <= 3) return;
    inputs[inputs.length - 1].remove();
    saveNames();
  });

  function refreshStats(){
    statSpins.textContent = "Spins: " + state.spinCount;
    statJackpots.textContent = "Jackpots: " + state.jackpots;
    const rate = state.spinCount ? ((state.jackpots/state.spinCount)*100).toFixed(1) : "0.0";
    statRate.textContent = "Rate: " + rate + "%";
    statChance.textContent = "Chance: " + Math.round((state.jackpotChance||0.2)*100) + "%";
    historyDiv.innerHTML = "";
    state.history.slice(-8).reverse().forEach(h=>{
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = h.text;
      historyDiv.appendChild(chip);
    });
  }

  // --- CONFETTI / FIREWORKS ---
  const canvas = document.getElementById("confetti");
  const ctx = canvas.getContext("2d");
  function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  resizeCanvas(); window.addEventListener("resize", resizeCanvas);

  function makeConfetti() {
    resizeCanvas();
    const particles = [];
    for (let i=0;i<220;i++){
      particles.push({ x:Math.random()*canvas.width, y:-20-Math.random()*canvas.height, r:Math.random()*4+2, color:`hsl(${Math.random()*360},100%,50%)`, vy:2+Math.random()*2, vx:-1+Math.random()*2 });
    }
    const start = performance.now();
    function draw(now){
      const elapsed = now - start;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      particles.forEach(p=>{
        p.x += p.vx; p.y += p.vy;
        ctx.beginPath(); ctx.fillStyle=p.color; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      });
      if (elapsed < 4000) requestAnimationFrame(draw);
    }
    requestAnimationFrame(draw);
  }
  function makeFirework(){
    resizeCanvas();
    const x = Math.random()*canvas.width, y = Math.random()*canvas.height/2;
    const ps = [];
    for(let i=0;i<70;i++){
      const a = (i/70)*Math.PI*2, s = 1+Math.random()*6;
      ps.push({ x,y, r:2, dx:Math.cos(a)*s, dy:Math.sin(a)*s, color:`hsl(${Math.random()*360},100%,50%)` });
    }
    const start = performance.now();
    function anim(now){
      const t = now - start;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ps.forEach(p=>{ p.x+=p.dx; p.y+=p.dy; p.r*=0.97; ctx.beginPath(); ctx.arc(p.x,p.y,Math.max(0.2,p.r),0,Math.PI*2); ctx.fillStyle=p.color; ctx.fill(); });
      if (t<900) requestAnimationFrame(anim);
    }
    requestAnimationFrame(anim);
  }

  // --- LOGO & GIF PERSIST/RENDER ---
  function renderLogo(){
    if (state.logoDataUrl){
      logoEl.src = state.logoDataUrl;
      logoEl.style.display = "block";
    } else {
      logoEl.style.display = "none";
    }
  }
  function saveLogoUrlFromInput(){
    const url = (logoUrlInput.value||"").trim();
    state.logoDataUrl = url;
    saveState(); renderLogo();
  }
  logoUrlInput?.addEventListener("change", saveLogoUrlFromInput);
  clearLogoBtn?.addEventListener("click", ()=>{ state.logoDataUrl=""; saveState(); renderLogo(); logoUrlInput.value=""; });

  logoFileInput?.addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ()=>{ state.logoDataUrl = r.result; saveState(); renderLogo(); logoUrlInput.value=""; };
    r.readAsDataURL(f);
  });

  function renderGifUrlInputs(){
    if (state.gifUrl){ gifUrlInput.value = state.gifUrl; }
  }
  gifUrlInput?.addEventListener("change", ()=>{
    state.gifUrl = (gifUrlInput.value||"").trim();
    saveState();
  });

  function showDanceGif(){
    const url = state.gifUrl || "images/dance.gif"; // default path
    danceGifEl.src = url;
    danceGifEl.style.display = "block";
    danceGifEl.style.opacity = "1";
    setTimeout(()=>{ danceGifEl.style.opacity = "0"; }, 3200);
    setTimeout(()=>{ danceGifEl.style.display = "none"; }, 3800);
  }

  // --- SPIN ---
  function spin(){
    if (spinning) return;

    // Validate min faces
    if (getFaces().length < 3){
      resultDiv.textContent = "Please set at least 3 player names.";
      if (!muted) failSound.play().catch(()=>{});
      return;
    }

    spinning = true;
    state.spinCount++; saveState(); refreshStats();

    const faces = getFaces();
    const roll = Math.random();
    const isJackpot = roll < (state.jackpotChance ?? 0.2);
    if (isJackpot) state.jackpotChance = 0.2;
    else state.jackpotChance = Math.min((state.jackpotChance ?? 0.2)+0.1, 1.0);
    saveState(); refreshStats();

    const jackpotSymbol = faces[Math.floor(Math.random() * faces.length)];
    const durations = [1700, 2500, 3300];

    const start = performance.now();
    const starts = [start,start,start];
    const done = [false,false,false];

    if (!muted) { spinMusic.currentTime = 0; spinMusic.play().catch(()=>{}); }

    function updateReel(i, now){
      const elapsed = now - starts[i];
      if (elapsed < durations[i]){
        const rand = Math.floor(Math.random()*faces.length);
        reels[i].textContent = faces[rand];
        if (!muted && elapsed - (reels[i]._lastTick||0) > 110){ 
          tickSound.currentTime = 0; 
          tickSound.play().catch(()=>{}); 
          reels[i]._lastTick = elapsed; 
        }
      } else if (!done[i]){
        reels[i].textContent = isJackpot ? jackpotSymbol : faces[Math.floor(Math.random()*faces.length)];
        done[i] = true;
      }
    }
    function loop(now){
      updateReel(0,now); updateReel(1,now); updateReel(2,now);
      if (done[0] && done[1] && done[2]) endSpin(isJackpot, jackpotSymbol);
      else requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    spinBtn.disabled = true;
    resetBtn.style.display = "none";
  }

  function endSpin(isJackpot, symbol){
    let text;
    if (isJackpot){
      state.jackpots++; saveState(); refreshStats();
      text = "üéâ YOUR CAPTAIN IS ... " + symbol + " üéâ";
      makeConfetti();
      for(let i=0;i<10;i++) setTimeout(makeFirework, i*600);
      showDanceGif();
      if (!muted) { jackpotSound.currentTime = 0; jackpotSound.play().catch(()=>{}); }
    } else {
      const vals = reels.map(r=>r.textContent);
      text = vals.join(" | ");
      if (!muted) { failSound.currentTime = 0; failSound.play().catch(()=>{}); }
    }
    resultDiv.textContent = text;
    state.history.push({ ts: Date.now(), text }); if (state.history.length>24) state.history.shift();
    saveState(); refreshStats();

    spinBtn.disabled = false;
    resetBtn.style.display = "inline-block";
    spinning = false;
  }

  function resetGame(){
    resultDiv.textContent = "";
    reels.forEach(r=> r.textContent = "?");
    resetBtn.style.display = "none";
  }

  // --- SAVE IMAGE (1080x1350 poster) ---
  async function saveImage(){
    const W = 1080, H = 1350;
    const cvs = document.createElement("canvas");
    const c = cvs.getContext("2d");
    cvs.width = W; cvs.height = H;

    // bg gradient (theme)
    const th = themes[state.theme] || themes["Default"];
    const grad = c.createLinearGradient(0,0,W,H);
    grad.addColorStop(0, th.bg1); grad.addColorStop(1, th.bg2);
    c.fillStyle = grad; c.fillRect(0,0,W,H);

    // title
    c.fillStyle = "#ffffff";
    c.font = "bold 48px system-ui, -apple-system, Segoe UI, Roboto";
    c.textAlign = "center";
    c.fillText("FPL Slot Machine ‚Äî Pro", W/2, 90);

    // result / reels
    const centerY = 540;
    const reelW = 280, reelH = 280, gap = 40;
    const startX = (W - (reelW*3 + gap*2))/2;

    function drawReel(x, y, w, h, text){
      // card
      c.fillStyle = "#ffffff";
      roundRect(c, x, y, w, h, 28, true, false);
      // text
      c.fillStyle = "#111";
      c.font = "900 56px system-ui, -apple-system, Segoe UI, Roboto";
      c.textAlign = "center";
      c.textBaseline = "middle";
      c.fillText(text || "?", x + w/2, y + h/2);
    }
    function roundRect(ctx, x, y, w, h, r, fill, stroke){
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }

    // reels use current DOM text
    const vals = reels.map(r=>r.textContent || "?");
    drawReel(startX, centerY-reelH/2, reelW, reelH, vals[0]);
    drawReel(startX+reelW+gap, centerY-reelH/2, reelW, reelH, vals[1]);
    drawReel(startX+2*(reelW+gap), centerY-reelH/2, reelW, reelH, vals[2]);

    // result text
    c.fillStyle = "#ffffff";
    c.font = "900 60px system-ui, -apple-system, Segoe UI, Roboto";
    c.textAlign = "center";
    const resText = (resultDiv.textContent||"").trim() || "Spin to pick your captain!";
    wrapText(c, resText, W/2, 940, 920, 64);

    // badge stats
    c.font = "bold 28px system-ui, -apple-system, Segoe UI, Roboto";
    c.textAlign = "left";
    c.fillText(`Spins: ${state.spinCount}`, 80, H-180);
    c.fillText(`Jackpots: ${state.jackpots}`, 80, H-140);
    c.fillText(`Hit Rate: ${state.spinCount ? ((state.jackpots/state.spinCount)*100).toFixed(1) : "0.0"}%`, 80, H-100);

    // accent underline
    c.strokeStyle = th.accent;
    c.lineWidth = 6;
    c.beginPath(); c.moveTo(80, H-90); c.lineTo(W-80, H-90); c.stroke();

    // logo (if any)
    if (state.logoDataUrl){
      try {
        const img = await loadImage(state.logoDataUrl);
        const L = 140;
        c.save();
        c.globalAlpha = 0.95;
        c.drawImage(img, W-80-L, 80, L, L);
        c.restore();
      } catch {}
    }

    // signature
    c.font = "700 24px system-ui, -apple-system, Segoe UI, Roboto";
    c.fillStyle = "#eaeaea";
    c.textAlign = "right";
    c.fillText("Made with SLLVP (Accountant ‚â† Dev üòÖ)", W-80, H-40);

    // download
    const url = cvs.toDataURL("image/png");
    const a = document.createElement("a");
    const ts = new Date();
    const name = `fpl_slot_result_${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,'0')}${String(ts.getDate()).padStart(2,'0')}_${String(ts.getHours()).padStart(2,'0')}${String(ts.getMinutes()).padStart(2,'0')}${String(ts.getSeconds()).padStart(2,'0')}.png`;
    a.href = url; a.download = name; a.click();

    // helpers
    function loadImage(src){
      return new Promise((resolve,reject)=>{
        const im = new Image();
        im.crossOrigin = "anonymous";
        im.onload = ()=>resolve(im);
        im.onerror = reject;
        im.src = src;
      });
    }
    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      const words = text.split(' ');
      let line = '';
      const lines = [];
      for (let n=0; n<words.length; n++){
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && n > 0){
          lines.push(line);
          line = words[n] + ' ';
        } else {
          line = testLine;
        }
      }
      lines.push(line);
      lines.forEach((ln,i)=> ctx.fillText(ln.trim(), x, y + i*lineHeight));
    }
  }

  // Wire buttons
  spinBtn.addEventListener("click", spin);
  resetBtn.addEventListener("click", resetGame);
  saveBtn.addEventListener("click", saveImage);

  // --- INIT ---
  loadState();
  if (typeof state.jackpotChance !== "number" || isNaN(state.jackpotChance)) state.jackpotChance = 0.2;

  // Inputs initial & persist
  populateInputs();
  themeSelect.value = state.theme || "Default";
  applyTheme(themeSelect.value);
  refreshStats();
  setMuted(false); // sound on by default
  // logo + gif
  renderLogo();
  renderGifUrlInputs();
  if (state.logoDataUrl && !logoUrlInput.value) logoUrlInput.value = state.logoDataUrl;

})();
</script>
<footer>Made with SLLVP who is accountant not Developerüíö</footer>
</body>
</html>
